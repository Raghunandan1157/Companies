<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ramraj ‚Ä¢ Counter Dashboard</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase JS v2 (Main + Connection) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --canvas-1:#0C1216; --canvas-2:#0E1719;
      --mint-1:#1CD2A0;  --mint-2:#36E3C0;
      --purple-1:#6E64E8; --purple-2:#8E86FF;
      --ink-1:#EAF3EF; --ink-2:#A7BBB4;
      --card-bg: rgba(20,28,32,0.60); --card-ring: rgba(255,255,255,0.08);
    }
    html,body{height:100%}
    body{
      color:var(--ink-1);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans";
      background:
        radial-gradient(800px 400px at 20% 10%, rgba(54,227,192,.12), transparent 60%),
        radial-gradient(700px 500px at 85% 15%, rgba(28,210,160,.10), transparent 70%),
        linear-gradient(180deg, var(--canvas-1), var(--canvas-2));
    }
    .vignette:before{content:"";position:fixed;inset:0;pointer-events:none;background:radial-gradient(ellipse at center, transparent 50%, rgba(0,0,0,.35) 100%);z-index:0;}
    .glass{background:var(--card-bg);backdrop-filter: blur(16px);-webkit-backdrop-filter: blur(16px);border:1px solid var(--card-ring);border-radius:22px;box-shadow:0 20px 40px rgba(0,0,0,.35),inset 0 1px 0 rgba(255,255,255,.06);}
    .rail-btn{background: rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);backdrop-filter: blur(10px);}
    .rail-btn.active{box-shadow: inset 0 0 0 2px rgba(54,227,192,.6);background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));}
    .mint-bg{ background: linear-gradient(135deg, var(--mint-1), var(--mint-2)); }
    .tab-pane{ display:none; } .tab-pane.active{ display:block; }
    .lift:hover{ transform: translateY(-2px); transition: transform .2s ease; }
    .dot{ width:10px; height:10px; border-radius:999px; display:inline-block; }

    .conn-card{background:rgba(2,6,23,.75);border:1px solid rgb(30,41,59);border-radius:16px;box-shadow:0 8px 30px rgba(2,6,23,.35);backdrop-filter:blur(6px)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}

    .mini-card{min-width:160px}
    .badge{font-size:11px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);padding:.125rem .5rem;border-radius:999px}

    .day-panel{display:none}
    .day-panel.show{display:block}

    #toast{transition:opacity .25s ease, transform .25s ease}
    #toast.hide{opacity:0; transform:translate(-50%, 8px)}

    .filter-btn{font-size:12px;padding:.35rem .6rem;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06)}
    .filter-btn.active{box-shadow: inset 0 0 0 2px rgba(54,227,192,.6);}

    #fs-overlay{background:rgba(0,0,0,.65);}

    .main-shell{transition:padding .2s ease, margin .2s ease;}

    @media (max-width: 1200px){
      body{padding:0 0 2rem;}
    }
    @media (max-width: 1024px){
      aside{
        position:relative;
        left:auto; right:auto; top:auto; bottom:auto;
        width:auto;
        margin:1.25rem 1rem 0;
      }
      .main-shell{
        padding-left:1rem !important;
        padding-right:1rem !important;
      }
    }
    @media (max-width: 640px){
      .responsive-header{flex-direction:column; align-items:flex-start;}
      #weekly-card canvas{min-height:220px;}
      #weekly-card .chart-shell{height:clamp(220px,45vh,360px);}
    }
  </style>
</head>
<body class="vignette relative">
  <!-- Sidebar -->
  <aside class="glass flex flex-col p-4 gap-3 z-10 w-full max-w-2xl mx-auto lg:mx-0 lg:w-60 relative lg:fixed lg:left-6 lg:top-6 lg:bottom-6">
    <div class="flex flex-col gap-2 px-2 pb-2 border-b border-white/10">
      <div class="flex items-center gap-2">
        <img src="https://ramrajcotton.in/cdn/shop/files/ramraj_logo_155x@2x.jpg?v=1631932971" alt="Ramraj classic logo" class="h-10 w-auto rounded-lg bg-white/90 p-1 shadow ring-1 ring-white/40">
        <img src="https://cdn.shopify.com/s/files/1/0094/0716/8559/files/ramraj-cotton-logo_a9185bba-23f7-4ec6-82cf-dcd8f9831af5.jpg?width=220" alt="Ramraj cotton crest" class="h-10 w-auto rounded-lg bg-white/90 p-1 shadow ring-1 ring-white/40">
        <div>
          <div class="font-semibold tracking-wide">Ramraj</div>
          <div class="text-[10px] uppercase tracking-[3px] text-slate-400">Ops Control</div>
        </div>
      </div>
      <div class="text-xs text-slate-400">Real-time counter console</div>
    </div>

    <nav class="mt-2 grid gap-2 text-sm font-medium">
      <button id="nav-main" class="rail-btn rounded-xl px-3 py-2 text-left flex items-center gap-3 active">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 10.5L12 3l9 7.5v8a2 2 0 0 1-2 2h-5v-6H10v6H5a2 2 0 0 1-2-2v-8Z" stroke="currentColor" stroke-width="1.5"/></svg>
        <span>Main View</span>
      </button>
      <button id="nav-settings" class="rail-btn rounded-xl px-3 py-2 text-left flex items-center gap-3">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 8a4 4 0 1 0 0 8a4 4 0 0 0 0-8Z" stroke="currentColor" stroke-width="1.5"/><path d="M4 12h2M18 12h2M12 4v2M12 18v2M6.2 6.2l1.4 1.4M16.4 16.4l1.4 1.4M6.2 17.8l1.4-1.4M16.4 7.6l1.4-1.4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
        <span>Settings View</span>
      </button>
      <button id="nav-connection" class="rail-btn rounded-xl px-3 py-2 text-left flex items-center gap-3">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M4 7h16M7 12h10M9 17h6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
        <span>Connection View</span>
      </button>
    </nav>

    <div class="mt-auto text-xs text-white/60 px-2">¬© 2025</div>
  </aside>

  <!-- Main area -->
  <main class="main-shell max-w-[1400px] mx-auto px-4 lg:px-6 lg:pl-[19rem] pt-6 pb-16 lg:pb-12 relative z-10">
    <!-- Top Bar -->
    <header class="responsive-header flex flex-wrap items-center gap-5 mb-6 w-full">
      <div class="flex items-center gap-3">
        <img src="https://ramrajcotton.in/cdn/shop/files/ramraj_logo_155x@2x.jpg?v=1631932971" alt="Ramraj badge" class="h-10 w-auto rounded-md bg-white/90 p-1 shadow ring-1 ring-white/30">
        <img src="https://cdn.shopify.com/s/files/1/0094/0716/8559/files/ramraj-cotton-logo_a9185bba-23f7-4ec6-82cf-dcd8f9831af5.jpg?width=200" alt="Ramraj crest" class="h-10 w-auto rounded-md bg-white/90 p-1 shadow ring-1 ring-white/30">
        <span class="text-lg font-semibold tracking-wide">Ramraj</span>
      </div>
      <div class="flex-1"></div>
      <div id="main-conn-pill" class="hidden md:inline-flex items-center gap-2 text-sm px-3 py-1 rounded-full border border-white/10 bg-white/5">
        <span class="w-2 h-2 rounded-full bg-yellow-400"></span>
        <span id="main-conn-text">Connecting‚Ä¶</span>
      </div>
      <div class="flex items-center gap-3 ml-3">
        <span class="text-sm opacity-90">Hi <b>VRUSHAB</b></span>
       <!-- Avatar with fullscreen click -->
<!-- Avatar thumbnail -->
<img
  id="avatar"
  class="w-9 h-9 rounded-full object-cover ring-2 ring-white/10 cursor-pointer"
  src="./123.png"
  alt="avatar"
/>

<!-- Fullscreen overlay -->
<div
  id="imageOverlay"
  class="fixed inset-0 bg-black/90 hidden items-center justify-center z-50"
>
  <img id="overlayImage" src="./123.png" class="max-w-full max-h-full rounded-xl shadow-lg" />
</div>

<script>
  const avatar = document.getElementById("avatar");
  const overlay = document.getElementById("imageOverlay");
  const overlayImage = document.getElementById("overlayImage");

  avatar.addEventListener("click", () => {
    // Show overlay and first image
    overlay.classList.remove("hidden");
    overlay.classList.add("flex");
    overlayImage.src = "./123.png";

    // After 3 seconds, switch to 111.png
    setTimeout(() => {
      overlayImage.src = "./111.png";
    }, 3000);
  });

  // Close on click
  overlay.addEventListener("click", () => {
    overlay.classList.add("hidden");
    overlay.classList.remove("flex");
  });
</script>


      </div>
    </header>

    <!-- ========== TABS ========== -->
    <!-- MAIN VIEW -->
    <section id="view-main" class="tab-pane active">
      <div class="grid grid-cols-1 lg:grid-cols-[2fr,1fr] gap-6">
        <!-- LEFT COLUMN -->
        <div class="flex flex-col gap-6">
          <!-- Chart Card -->
          <div class="glass p-5" id="weekly-card">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-3">
                <h2 class="text-lg font-semibold">COUNT</h2>
                <span class="badge" id="today-badge">Today ‚Ä¢ 0</span>
              </div>
              <!-- Filters + Fullscreen  (Overall ONLY in Fullscreen) -->
              <div class="flex items-center gap-2">
                <button class="filter-btn active" data-range="today">Today</button>
                <button class="filter-btn" data-range="week">Week</button>
                <button class="filter-btn" data-range="year">Year</button>
                <!-- Overall removed here by design -->
                <button id="btn-full" class="filter-btn" title="Full Screen">‚§¢</button>
              </div>
            </div>

            <div class="chart-shell rounded-lg overflow-hidden relative" style="height:clamp(240px,42vh,340px)">
              <canvas id="weeklyChart"></canvas>
            </div>

            <!-- Slot/Day panel (kept) -->
            <div id="day-panel" class="day-panel mt-3">
              <div class="glass p-4">
                <div class="flex items-center justify-between">
                  <div class="font-semibold" id="day-panel-title">‚Äî</div>
                  <button id="day-panel-close" class="text-sm opacity-80 hover:opacity-100">Close ‚úï</button>
                </div>
                <ul id="day-panel-list" class="text-sm text-slate-200 mt-2 space-y-1"></ul>
              </div>
            </div>

            <!-- Yesterday / Today / Tomorrow -->
            <div class="mt-3 flex justify-end">
              <div class="grid grid-cols-3 gap-3">
                <div class="glass p-3 mini-card">
                  <div class="text-xs opacity-75" id="y-label">Yesterday (‚Äî)</div>
                  <div class="text-xl font-bold" id="y-val">0</div>
                </div>
                <div class="glass p-3 mini-card">
                  <div class="text-xs opacity-75" id="t-label">Today (‚Äî)</div>
                  <div class="text-xl font-bold text-emerald-400" id="t-val">0</div>
                </div>
                <div class="glass p-3 mini-card">
                  <div class="flex items-center justify-between">
                    <div class="text-xs opacity-75" id="tm-label">Tomorrow (‚Äî)</div>
                    <span class="badge opacity-80">Predicted</span>
                  </div>
                  <div class="text-xl font-bold text-purple-300" id="tm-val">1</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Last updated -->
          <div class="glass p-5">
            <div class="text-sm opacity-85 mb-1">Last updated</div>
            <div class="text-base" id="main-last-update">‚Äî</div>
          </div>
        </div>

        <!-- RIGHT COLUMN: Counter -->
        <div class="glass p-6 relative">
          <div class="flex flex-wrap items-start justify-between gap-4 mb-5">
            <div>
              <div class="text-sm opacity-80">Current Counter</div>
              <div id="main-value" class="text-4xl font-extrabold text-emerald-400 mt-1">‚Äî</div>
              <div class="mt-2 text-xs">
                <span id="sync-state" class="badge">Connecting‚Ä¶</span>
              </div>
            </div>
            <div class="max-w-xs text-sm text-slate-300">
              <div class="text-xs uppercase tracking-[4px] text-emerald-300 mb-1">Manual override</div>
              <p>Type the exact number you need or roll back the latest entry from today.</p>
            </div>
          </div>

          <div class="flex flex-col gap-4">
            <div class="flex flex-col sm:flex-row gap-3">
              <input id="main-input" inputmode="numeric" pattern="[0-9]*" type="number" min="0"
                     class="flex-1 rounded-xl border border-white/10 bg-white/5 px-4 py-2 text-lg font-semibold tracking-wide text-emerald-100 placeholder-emerald-200/60 focus:outline-none focus:ring-2 focus:ring-emerald-400"
                     placeholder="Type the desired count">
              <button id="main-save" class="mint-bg px-5 py-2 rounded-xl text-sm font-semibold text-slate-900">Save Number</button>
            </div>
            <div class="flex flex-col sm:flex-row gap-3">
              <button id="main-delete-today" class="px-5 py-2 rounded-xl bg-rose-600/80 hover:bg-rose-600 text-sm font-semibold text-white">Delete Today's Latest Entry</button>
              <p class="text-xs text-slate-400 sm:flex-1">Deletion is limited to rows recorded today (IST) so past days stay immutable.</p>
            </div>
          </div>

          <div id="main-err" class="text-sm text-red-400 hidden mt-4"></div>
          <div class="text-xs text-slate-400 mt-2">Auto-connects using the Connection tab settings.</div>
        </div>
      </div>
    </section>

    <!-- SETTINGS (now: Motivational Quotes) -->
    <section id="view-settings" class="tab-pane">
      <div class="grid gap-6">
        <div class="glass p-8 text-center">
          <div class="text-lg font-semibold mb-1">üí° Daily Push</div>
          <div class="text-sm opacity-70 mb-5">Tap <b>New Message</b> to shuffle a fresh line.</div>
          <div id="quote-card" class="max-w-3xl mx-auto">
            <blockquote id="quote-text" class="text-2xl leading-8"></blockquote>
          </div>
          <div class="mt-6 flex items-center justify-center gap-3">
            <button id="quote-next" class="rail-btn px-4 py-2 rounded-lg">New Message</button>
            <button id="quote-shuffle" class="rail-btn px-4 py-2 rounded-lg">Shuffle Deck</button>
            <button id="quote-copy" class="rail-btn px-4 py-2 rounded-lg">Copy</button>
          </div>
        </div>

        <div class="glass p-10 text-center text-slate-300">
          <div class="text-lg font-semibold mb-2">üéõÔ∏è Randomizer (extra)</div>
          <div class="flex items-center justify-center gap-3">
            <input type="range" min="0" max="100" class="w-72">
            <button class="rail-btn px-3 py-1 rounded-lg">Shuffle</button>
          </div>
        </div>
      </div>
    </section>

    <!-- CONNECTION VIEW -->
    <section id="view-connection" class="tab-pane">
      <main class="w-full max-w-4xl mx-auto p-2 sm:p-4 space-y-6">
        <section class="conn-card p-6">
          <h1 class="text-2xl font-semibold mb-2">üî¢ Supabase Number (with +100/+200/+500)</h1>
          <p class="text-slate-400 text-sm mb-4">
            Paste your details, then click <b>Connect & Load</b>.<br/>We‚Äôll read the newest row (by <b>id desc</b>). Each action <b>creates a new row</b> with the updated number.
          </p>
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm text-slate-300">Supabase URL</label>
              <input id="sb-url" class="w-full mt-1 p-2 rounded bg-slate-900 border border-slate-800 focus:outline-none focus:ring focus:ring-blue-600"
                     value="https://zovnmmdfthpbubrorsgh.supabase.co"
                     placeholder="https://YOUR-PROJECT-REF.supabase.co">
              <p class="text-xs text-slate-400 mt-1">Settings ‚Üí API ‚Üí Project URL</p>
            </div>
            <div>
              <label class="text-sm text-slate-300 flex items-center justify-between">
                Supabase Anon (public) Key
                <button id="toggle-key" class="text-xs text-blue-400 hover:underline" type="button">show</button>
              </label>
              <input id="sb-key" type="password" class="w-full mt-1 p-2 rounded bg-slate-900 border border-slate-800 focus:outline-none focus:ring focus:ring-blue-600"
                     value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpvdm5tbWRmdGhwYnVicm9yc2doIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1NzE3ODgsImV4cCI6MjA3NzE0Nzc4OH0.92BH2sjUOgkw6iSRj1_4gt0p3eThg3QT4VK-Q4EdmBE"
                     placeholder="Paste the anon public key">
              <p class="text-xs text-slate-400 mt-1">Settings ‚Üí API ‚Üí anon public</p>
            </div>
            <div>
              <label class="text-sm text-slate-300">Table name</label>
              <input id="tb-name" class="w-full mt-1 p-2 rounded bg-slate-900 border border-slate-800 focus:outline-none focus:ring focus:ring-blue-600"
                     value="Companies"
                     placeholder="e.g. metrics">
              <p class="text-xs text-slate-400 mt-1">If spaces cause issues, use a view like <span class="mono">it_dept</span>.</p>
            </div>
            <div>
              <label class="text-sm text-slate-300">Number column</label>
              <input id="col-name" class="w-full mt-1 p-2 rounded bg-slate-900 border border-slate-800 focus:outline-none focus:ring focus:ring-blue-600"
                     value="Number_column"
                     placeholder="e.g. total">
              <p class="text-xs text-slate-400 mt-1">Case-sensitive if you used capitals.</p>
            </div>
            <div class="md:col-span-2">
              <label class="text-sm text-slate-300">Timestamp column</label>
              <input id="tcol-name" class="w-full mt-1 p-2 rounded bg-slate-900 border border-slate-800 focus:outline-none focus:ring focus:ring-blue-600"
                     value="date"
                     placeholder="e.g. created_at">
              <p class="text-xs text-slate-400 mt-1">This is the column we group by for the chart/strips (use your <span class="mono">created_at</span> or trigger column).</p>
            </div>
          </div>
          <div class="flex items-center gap-3 mt-5">
            <button id="connect" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-medium">Connect & Load</button>
            <span id="busy" class="text-slate-400 text-sm hidden">Working‚Ä¶</span>
            <span id="status" class="text-slate-400 text-sm"></span>
          </div>
        </section>

        <section class="conn-card p-6">
          <h2 class="text-xl font-semibold mb-3">Current Value</h2>
          <div id="value" class="text-5xl font-extrabold text-emerald-400">‚Äî</div>

          <div class="flex flex-wrap items-center gap-3 mt-6">
            <button data-add="100" class="add-btn bg-slate-800 hover:bg-slate-700 px-4 py-2 rounded">+100</button>
            <button data-add="200" class="add-btn bg-slate-800 hover:bg-slate-700 px-4 py-2 rounded">+200</button>
            <button data-add="500" class="add-btn bg-slate-800 hover:bg-slate-700 px-4 py-2 rounded">+500</button>
            <button id="refresh" class="bg-slate-800 hover:bg-slate-700 px-4 py-2 rounded">Refresh</button>
            <button id="reset" class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded">Reset to 0</button>
            <button id="delete-all" class="bg-red-700 hover:bg-red-800 px-4 py-2 rounded">üóëÔ∏è Delete All Rows</button>
          </div>

          <div id="err" class="mt-4 text-sm text-red-400 hidden"></div>

          <details class="mt-6">
            <summary class="cursor-pointer text-slate-300">The exact code we just ran</summary>
            <pre id="code" class="mono text-sm bg-slate-900 border border-slate-800 rounded-lg p-4 overflow-auto"></pre>
          </details>

          <details class="mt-3">
            <summary class="cursor-pointer text-slate-300">Raw response (debug)</summary>
            <pre id="debug" class="mono text-xs bg-slate-900 border border-slate-800 rounded-lg p-4 overflow-auto"></pre>
          </details>
        </section>
      </main>
    </section>
  </main>

  <!-- Fullscreen overlay -->
  <div id="fs-overlay" class="fixed inset-0 hidden z-50">
    <div class="w-full h-full flex flex-col">
      <div class="p-4 flex items-center justify-between">
        <div class="text-lg font-semibold">COUNT ‚Äî Full Screen</div>
        <div class="flex items-center gap-2">
          <button class="filter-btn active" data-range-fs="today">Today</button>
          <button class="filter-btn" data-range-fs="week">Week</button>
          <button class="filter-btn" data-range-fs="year">Year</button>
          <button class="filter-btn" data-range-fs="overall">Overall</button>
          <button id="btn-exit" class="filter-btn">Close</button>
        </div>
      </div>
      <div class="flex-1 px-6 pb-6">
        <div class="glass w-full h-full p-4">
          <canvas id="fsChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 px-3 py-2 rounded-lg bg-rose-600 text-white text-sm shadow hide opacity-0 pointer-events-none">
    <span id="toast-msg">Error</span>
  </div>

  <script>
    /* ====================== Tabs ====================== */
    const panes = {
      main: document.getElementById('view-main'),
      settings: document.getElementById('view-settings'),
      connection: document.getElementById('view-connection'),
    };
    const navs = {
      main: document.getElementById('nav-main'),
      settings: document.getElementById('nav-settings'),
      connection: document.getElementById('nav-connection'),
    };
    function showTab(name){
      Object.values(panes).forEach(p => p.classList.remove('active'));
      Object.values(navs).forEach(n => n.classList.remove('active'));
      panes[name].classList.add('active');
      navs[name].classList.add('active');
    }
    navs.main.addEventListener('click', ()=> showTab('main'));
    navs.settings.addEventListener('click', ()=> showTab('settings'));
    navs.connection.addEventListener('click', ()=> showTab('connection'));
    showTab('main');

    /* ====================== Helpers (IST) ====================== */
    const TZ = 'Asia/Kolkata';
    const F_KEY  = new Intl.DateTimeFormat('en-CA', { timeZone: TZ, year:'numeric', month:'2-digit', day:'2-digit' }); // YYYY-MM-DD
    const F_TIME = new Intl.DateTimeFormat(undefined, { timeZone: TZ, hour:'2-digit', minute:'2-digit', second:'2-digit' });

    function keyIST(date){ return F_KEY.format(date); }
    function todayKey(){ return keyIST(new Date()); }
    function dateShiftDays(d, days){ const x = new Date(d); x.setDate(x.getDate()+days); return x; }
    function toast(msg){
      const t = document.getElementById('toast'), m = document.getElementById('toast-msg');
      m.textContent = msg; t.classList.remove('hide'); t.style.opacity=1; t.style.transform='translate(-50%,0)';
      setTimeout(()=>{ t.classList.add('hide'); t.style.opacity=0; }, 1800);
    }
    function istRangeForDay(d){
      const ymd = keyIST(d);
      const start = new Date(ymd + 'T00:00:00+05:30');
      const end   = new Date(new Date(ymd + 'T00:00:00+05:30').getTime() + 24*3600*1000);
      return { startISO: start.toISOString(), endISO: end.toISOString() };
    }
    const IST_OFFSET_MIN = 330;
    const ms = (n)=>n*1000;
    function hourIST(ts){
      const utcMs = new Date(ts).getTime();
      const istMs = utcMs + IST_OFFSET_MIN*60*1000;
      return new Date(istMs).getUTCHours(); // 0-23 in IST
    }
    function isFiniteNumber(n){ return typeof n==='number' && Number.isFinite(n); }

    /* ====================== Chart.js plugin: 3 guide lines ====================== */
    const SegmentGuides = {
      id:'segmentGuides',
      afterDatasetsDraw(chart){
        const N = chart.data.labels?.length || 0;
        if(N < 2) return;
        const x = chart.scales.x, y = chart.scales.y;
        const ctx = chart.ctx;
        const positions = [0.25, 0.5, 0.75].map(p => x.getPixelForValue(Math.round((N-1)*p)));
        ctx.save();
        ctx.lineWidth = 1;
        ctx.setLineDash([4,4]);
        ctx.strokeStyle = 'rgba(255,255,255,.10)';
        positions.forEach(px=>{
          ctx.beginPath();
          ctx.moveTo(px, y.top);
          ctx.lineTo(px, y.bottom);
          ctx.stroke();
        });
        ctx.restore();
      }
    };
    Chart.register(SegmentGuides);

    /* ====================== MOTIVATIONAL QUOTES ====================== */
    const QUOTES = [
      "Be relentless. Be kind. Be the one who shows up.",
      "Small wins, every day. Momentum beats motivation.",
      "Discipline is just choosing what you want most over what you want now.",
      "Start where you are. Use what you have. Do what you can.",
      "Courage is doing it scared.",
      "No zero days ‚Äî move one millimeter forward.",
      "If it matters, schedule it. If it‚Äôs scheduled, do it.",
      "Hard choices, easy life. Easy choices, hard life.",
      "Dream in decades. Execute in days.",
      "Don‚Äôt wish it were easier; wish you were better.",
      "The obstacle is the way.",
      "You don‚Äôt need permission. You need a plan.",
      "Win the morning, win the day.",
      "Fail fast. Learn faster. Never stop.",
      "Pressure is a privilege.",
      "Focus is a superpower ‚Äî protect it.",
      "Better prepared than lucky.",
      "Consistency compounds.",
      "Show up. Ship it. Improve it.",
      "Make it obvious. Make it easy. Make it inevitable."
    ];
    let quoteDeck = [];
    let quoteIdx = 0;
    function shuffle(arr){
      for(let i=arr.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
      }
      return arr;
    }
    function buildQuoteDeck(){
      quoteDeck = shuffle([...QUOTES]);
      quoteIdx = 0;
      localStorage.setItem('nb:quotes', JSON.stringify(quoteDeck));
    }
    function renderQuote(){
      if(!quoteDeck.length) buildQuoteDeck();
      const q = quoteDeck[quoteIdx % quoteDeck.length];
      document.getElementById('quote-text').textContent = "‚Äú" + q + "‚Äù";
      localStorage.setItem('nb:quoteIdx', String(quoteIdx));
    }
    function nextQuote(){
      quoteIdx = (quoteIdx + 1) % quoteDeck.length;
      renderQuote();
    }
    function restoreQuotes(){
      try{
        const saved = JSON.parse(localStorage.getItem('nb:quotes')||'[]');
        if(Array.isArray(saved) && saved.length===QUOTES.length) quoteDeck=saved;
        const i = Number(localStorage.getItem('nb:quoteIdx'));
        if(Number.isInteger(i)) quoteIdx=i%QUOTES.length;
      }catch{}
      if(!quoteDeck.length) buildQuoteDeck();
      renderQuote();
    }

    /* ====================== MAIN VIEW ====================== */
    (function MainView(){
      const pill = document.getElementById('main-conn-pill');
      const pillText = document.getElementById('main-conn-text');
      const valEl = document.getElementById('main-value');
      const lastUpdateEl = document.getElementById('main-last-update');
      const errEl = document.getElementById('main-err');
      const syncState = document.getElementById('sync-state');
      const manualInput = document.getElementById('main-input');
      const manualSaveBtn = document.getElementById('main-save');
      const deleteTodayBtn = document.getElementById('main-delete-today');

      const dayPanel = document.getElementById('day-panel');
      const dayPanelTitle = document.getElementById('day-panel-title');
      const dayPanelList = document.getElementById('day-panel-list');
      const dayPanelClose = document.getElementById('day-panel-close');

      const todayBadge = document.getElementById('today-badge');

      // Strip labels
      const yLabel = document.getElementById('y-label');
      const tLabel = document.getElementById('t-label');
      const tmLabel= document.getElementById('tm-label');
      const yVal = document.getElementById('y-val');
      const tVal = document.getElementById('t-val');
      const tmVal= document.getElementById('tm-val');

      const btnFull = document.getElementById('btn-full');
      const fsOverlay = document.getElementById('fs-overlay');
      const btnExit = document.getElementById('btn-exit');

      const filters = Array.from(document.querySelectorAll('.filter-btn[data-range]'));
      const fsFilters = Array.from(document.querySelectorAll('.filter-btn[data-range-fs]'));

      const getCfg = () => ({
        url:   localStorage.getItem('sb-num:sb-url')   || document.getElementById('sb-url')?.value || '',
        key:   localStorage.getItem('sb-num:sb-key')   || document.getElementById('sb-key')?.value || '',
        table: localStorage.getItem('sb-num:tb-name')  || document.getElementById('tb-name')?.value || 'Companies',
        col:   localStorage.getItem('sb-num:col-name') || document.getElementById('col-name')?.value || 'Number_column',
        tcol:  localStorage.getItem('sb-num:tcol-name') || document.getElementById('tcol-name')?.value || 'date',
      });

      let supa = null, cfg = getCfg();
      let chart = null, fsChart = null;
      let currentMode = 'today'; // 'today' | 'week' | 'year' | 'overall' (overall only in FS)
      let currentGroups = [];    // array of arrays of timestamps for click-panel
      let currentLabels = [];
      let currentData = [];

      function setConnState(state){
        pill.classList.remove('hidden');
        const dot = pill.querySelector('span');
        if(state==='ok'){ dot.className='w-2 h-2 rounded-full bg-emerald-400'; pillText.textContent='Connected ‚úî'; }
        else if(state==='fail'){ dot.className='w-2 h-2 rounded-full bg-rose-400'; pillText.textContent='Failed'; }
        else { dot.className='w-2 h-2 rounded-full bg-yellow-400'; pillText.textContent='Connecting‚Ä¶'; }
      }
      function setSync(text, ok=true){
        syncState.textContent = text;
        syncState.style.borderColor = ok ? 'rgba(52,211,153,.35)' : 'rgba(248,113,113,.5)';
        syncState.style.background = ok ? 'rgba(16,185,129,.10)' : 'rgba(239,68,68,.12)';
      }
      function showErr(msg){ errEl.textContent = '‚ùå '+msg; errEl.classList.remove('hidden'); }
      function clearErr(){ errEl.textContent=''; errEl.classList.add('hidden'); }

      // Listen for "rows cleared" from Connection view to hard reset UI
      window.addEventListener('sb:rows-cleared', ()=>{
        valEl.textContent = 0;
        lastUpdateEl.textContent = '‚Äî';
        todayBadge.textContent = 'Today ‚Ä¢ 0';
        currentData = currentLabels.map(()=>0);
        if(chart){ chart.data.datasets[0].data = currentData; chart.update(); }
        buildStrip().catch(()=>{});
      });

      // Connect & bootstrap
      async function connect(){
        clearErr(); setConnState('pending'); setSync('Connecting‚Ä¶', true);
        cfg = getCfg();
        if(!cfg.url || !cfg.key){ setConnState('fail'); setSync('Retry', false); return showErr('Please set URL/Key in Connection view.'); }
        supa = window.supabase.createClient(cfg.url, cfg.key);
        try{
          await refreshValue();
          await buildStrip();     // yesterday/today/tomorrow
          await buildAndRender(); // chart for currentMode
          setConnState('ok'); setSync('Synced', true);
        }catch(e){ setConnState('fail'); setSync('Retry', false); showErr(e.message||String(e)); }
      }

      // Latest value + last update
      async function refreshValue(){
        const { data, error } = await supa
          .from(cfg.table)
          .select(`${cfg.col}, ${cfg.tcol}`)
          .order('id',{ascending:false})
          .limit(1);
        if(error) throw error;
        const row = data?.[0];
        const value = Number(row?.[cfg.col]);
        valEl.textContent = isFiniteNumber(value) ? value : 0;
        lastUpdateEl.textContent = row?.[cfg.tcol]
          ? new Date(row[cfg.tcol]).toLocaleString(undefined,{ timeZone: TZ })
          : '‚Äî';
      }

      // Build Yesterday/Today/Tomorrow strip (7-day window)
      async function buildStrip(){
        const now = new Date();
        const start = dateShiftDays(now,-6);
        const { startISO } = istRangeForDay(start);
        const { endISO }   = istRangeForDay(dateShiftDays(now,1));

        const pre = await supa.from(cfg.table)
          .select(`${cfg.col}, ${cfg.tcol}`)
          .lt(cfg.tcol, startISO).order(cfg.tcol, {ascending:false}).limit(1);
        if(pre.error) throw pre.error;

        const win = await supa.from(cfg.table)
          .select(`${cfg.col}, ${cfg.tcol}`)
          .gte(cfg.tcol, startISO).lt(cfg.tcol, endISO)
          .order(cfg.tcol, {ascending:true}).limit(5000);
        if(win.error) throw win.error;

        // daily buckets
        const days = [];
        for(let i=6;i>=0;i--){
          const d = dateShiftDays(now,-i);
          days.push({ key:keyIST(d), count:0, times:[] });
        }
        const rows = (pre.data?.[0] ? [pre.data[0], ...win.data] : win.data).filter(Boolean);
        for(let i=1;i<rows.length;i++){
          const prev = rows[i-1], cur = rows[i];
          const delta = Number(cur[cfg.col]||0) - Number(prev[cfg.col]||0);
          const ts = cur[cfg.tcol] ? new Date(cur[cfg.tcol]) : null;
          if(delta>0 && ts){
            const k = keyIST(ts);
            const b = days.find(x=>x.key===k);
            if(b){ b.count += delta; b.times.push(ts); }
          }
        }

        const todayIdx = 6, yIdx = 5;
        const tCount = days[todayIdx]?.count || 0;
        const yCount = days[yIdx]?.count || 0;

        const todayDate = days[todayIdx]?.key || todayKey();
        const yDate = days[yIdx]?.key || keyIST(dateShiftDays(new Date(), -1));
        const tmDate = keyIST(dateShiftDays(new Date(), 1));

        yLabel.textContent  = `Yesterday (${yDate})`;
        tLabel.textContent  = `Today (${todayDate})`;
        tmLabel.textContent = `Tomorrow (${tmDate})`;

        yVal.textContent  = String(yCount);
        tVal.textContent  = String(tCount);
        todayBadge.textContent = `Today ‚Ä¢ ${tCount}`;

        // gentle optimistic prediction
        let pred = Math.max(tCount + 1, Math.ceil(tCount * 1.05));
        if(tCount === 0 && yCount > 0) pred = Math.max(1, Math.ceil(yCount * 1.05));
        if(tCount === 0 && yCount === 0) pred = 1;
        tmVal.textContent = String(pred);
      }

      // Generic fetch rows inside [startISO, endISO)
      async function fetchRows(startISO, endISO){
        const pre = await supa.from(cfg.table)
          .select(`${cfg.col}, ${cfg.tcol}`)
          .lt(cfg.tcol, startISO).order(cfg.tcol, {ascending:false}).limit(1);
        if(pre.error) throw pre.error;

        const win = await supa.from(cfg.table)
          .select(`${cfg.col}, ${cfg.tcol}`)
          .gte(cfg.tcol, startISO).lt(cfg.tcol, endISO)
          .order(cfg.tcol, {ascending:true}).limit(10000);
        if(win.error) throw win.error;

        return (pre.data?.[0] ? [pre.data[0], ...win.data] : win.data).filter(Boolean);
      }

      // Build chart data for mode
      async function buildFor(mode){
        const now = new Date();
        if(mode==='today'){
          const { startISO, endISO } = istRangeForDay(now);
          const rows = await fetchRows(startISO, endISO);

          const labels = ['Night','Morning','Afternoon','Evening'];
          const groups = [[],[],[],[]];
          const counts = [0,0,0,0];

          for(let i=1;i<rows.length;i++){
            const prev = rows[i-1], cur = rows[i];
            const delta = Number(cur[cfg.col]||0) - Number(prev[cfg.col]||0);
            const ts = cur[cfg.tcol];
            if(delta>0 && ts){
              const h = hourIST(ts);
              const idx = (h<6)?0:(h<12)?1:(h<18)?2:3;
              counts[idx] += delta;
              groups[idx].push(new Date(ts));
            }
          }
          const slotTitle = (idx)=>['Night (00‚Äì06)','Morning (06‚Äì12)','Afternoon (12‚Äì18)','Evening (18‚Äì24)'][idx];
          return { labels, data:counts, groups, modeTitle:slotTitle };
        }

        if(mode==='week'){
          const start = dateShiftDays(now,-6);
          const { startISO } = istRangeForDay(start);
          const { endISO }   = istRangeForDay(dateShiftDays(now,1));
          const rows = await fetchRows(startISO, endISO);

          const buckets = [];
          for(let i=6;i>=0;i--){
            const d = dateShiftDays(now,-i);
            buckets.push({ date:d, key:keyIST(d), count:0, times:[] });
          }
          for(let i=1;i<rows.length;i++){
            const prev=rows[i-1], cur=rows[i];
            const delta = Number(cur[cfg.col]||0) - Number(prev[cfg.col]||0);
            const ts = cur[cfg.tcol] ? new Date(cur[cfg.tcol]) : null;
            if(delta>0 && ts){
              const k = keyIST(ts);
              const b = buckets.find(x=>x.key===k);
              if(b){ b.count += delta; b.times.push(ts); }
            }
          }
          const labels = buckets.map(b => new Date(b.date).toLocaleDateString(undefined,{weekday:'short', timeZone:TZ}));
          const data   = buckets.map(b => b.count);
          const groups = buckets.map(b => b.times);
          const title  = (idx)=>`${buckets[idx]?.key || ''}`;
          return { labels, data, groups, modeTitle:title };
        }

        if(mode==='year'){
          const y = new Date().toLocaleString('en-CA',{timeZone:TZ, year:'numeric'});
          const start = new Date(`${y}-01-01T00:00:00+05:30`);
          const end   = new Date(`${Number(y)+1}-01-01T00:00:00+05:30`);
          const rows = await fetchRows(start.toISOString(), end.toISOString());

          const months = Array.from({length:12}, (_,i)=>({i, count:0, times:[]}));
          for(let i=1;i<rows.length;i++){
            const prev=rows[i-1], cur=rows[i];
            const delta = Number(cur[cfg.col]||0) - Number(prev[cfg.col]||0);
            const ts = cur[cfg.tcol] ? new Date(cur[cfg.tcol]) : null;
            if(delta>0 && ts){
              const m = Number(new Date(ts).toLocaleString('en-CA',{ timeZone:TZ, month:'numeric'})) - 1;
              if(months[m]){ months[m].count += delta; months[m].times.push(ts); }
            }
          }
          const labels = months.map(()=> ''); // uncluttered
          const data   = months.map(m=>m.count);
          const groups = months.map(m=>m.times);
          const title  = (idx)=>`Month ${idx+1}`;
          return { labels, data, groups, modeTitle:title };
        }

        if(mode==='overall'){
          const earliest = await supa.from(cfg.table)
            .select(`${cfg.tcol}`).order(cfg.tcol,{ascending:true}).limit(1);
          const firstTs = earliest.data?.[0]?.[cfg.tcol];
          const startDate = firstTs ? new Date(firstTs) : dateShiftDays(new Date(), -365*2);
          const y = new Date(startDate.toLocaleString('en-CA',{timeZone:TZ, year:'numeric'}));
          const m = Number(new Date(startDate).toLocaleString('en-CA',{timeZone:TZ, month:'numeric'})) - 1;
          const start = new Date(`${y.getFullYear()}-${String(m+1).padStart(2,'0')}-01T00:00:00+05:30`);
          const end   = new Date(new Date().toLocaleString('en-CA',{timeZone:TZ, year:'numeric'})+'-12-31T24:00:00+05:30');
          const rows = await fetchRows(start.toISOString(), end.toISOString());

          const months = [];
          const cursor = new Date(start);
          const maxMonths = 36;
          while(cursor <= new Date() && months.length < maxMonths){
            months.push({ y: cursor.getFullYear(), m: cursor.getMonth()+1, count:0, times:[] });
            cursor.setMonth(cursor.getMonth()+1);
          }
          for(let i=1;i<rows.length;i++){
            const prev=rows[i-1], cur=rows[i];
            const delta = Number(cur[cfg.col]||0) - Number(prev[cfg.col]||0);
            const ts = cur[cfg.tcol] ? new Date(cur[cfg.tcol]) : null;
            if(delta>0 && ts){
              const yy = Number(new Date(ts).toLocaleString('en-CA',{timeZone:TZ, year:'numeric'}));
              const mm = Number(new Date(ts).toLocaleString('en-CA',{timeZone:TZ, month:'numeric'}));
              const bucket = months.find(b=>b.y===yy && b.m===mm);
              if(bucket){ bucket.count += delta; bucket.times.push(ts); }
            }
          }
          const labels = months.map(()=> '');
          const data   = months.map(b=>b.count);
          const groups = months.map(b=>b.times);
          const title  = (idx)=>`M${months[idx]?.m || ''}/${months[idx]?.y || ''}`;
          return { labels, data, groups, modeTitle:title };
        }
      }

      async function buildAndRender(){
        const { labels, data, groups, modeTitle } = await buildFor(currentMode);
        currentLabels = labels; currentData = data; currentGroups = groups;

        const ctx = document.getElementById('weeklyChart').getContext('2d');
        const grad = (c) => {
          const { chart } = c;
          const { top, bottom } = chart.chartArea || { top:0, bottom:0 };
          const g = chart.ctx.createLinearGradient(0, bottom, 0, top);
          g.addColorStop(0, 'rgba(110,100,232,0.10)');
          g.addColorStop(1, 'rgba(142,134,255,0.35)');
          return g;
        };

        const options = {
          responsive:true, maintainAspectRatio:false,
          animation:{ duration:400, easing:'easeOutCubic' },
          interaction:{ mode:'nearest', intersect:false },
          scales:{
            x:{
              grid:{display:false},
              ticks:{
                color:'rgba(234,243,239,.85)',
                font:{size:12,weight:600},
                callback: (_, i)=> (currentMode==='year' || currentMode==='overall') ? '' : (currentLabels[i] ?? '')
              }
            },
            y:{ beginAtZero:true, ticks:{ color:'rgba(234,243,239,.65)', precision:0 }, grid:{ color:'rgba(255,255,255,.06)', drawBorder:false } }
          },
          plugins:{ legend:{display:false}, tooltip:{ backgroundColor:'rgba(20,28,32,.92)', borderColor:'rgba(255,255,255,.08)', borderWidth:1, titleColor:'#EAF3EF', bodyColor:'#EAF3EF' } },
          onClick: (_, elements)=>{
            // Detail panel available in both modes; keep as-is
            if(!elements.length) return;
            const idx = elements[0].index;
            openPanel(idx, modeTitle);
          }
        };

        if(chart){
          chart.data.labels = currentLabels;
          chart.data.datasets[0].data = currentData;
          chart.update();
        }else{
          chart = new Chart(ctx, {
            type:'line',
            data:{ labels: currentLabels, datasets:[{
              label:'Count',
              data: currentData,
              tension:.35,
              fill:true,
              borderWidth:2,
              borderColor:'#8E86FF',
              backgroundColor: grad,
              pointRadius:4,
              pointHoverRadius:6,
              pointBackgroundColor:'#8E86FF',
              pointBorderWidth:0
            }]},
            options,
            plugins:[SegmentGuides]
          });
        }

        // sync fullscreen chart if open
        if(!fsOverlay.classList.contains('hidden')) renderFull();
      }

      function openPanel(idx, modeTitleFn){
        const times = currentGroups[idx] || [];
        const title = modeTitleFn(idx);
        dayPanelTitle.textContent = title;
        if(!times.length){
          dayPanelList.innerHTML = `<li class="text-slate-300">No events recorded.</li>`;
        }else{
          const items = times
            .sort((a,b)=>a-b)
            .map(t => `<li class="flex items-center gap-2"><span class="dot" style="background:linear-gradient(135deg,#1CD2A0,#36E3C0)"></span><span>${F_TIME.format(t)}</span></li>`)
            .join('');
          dayPanelList.innerHTML = items;
        }
        dayPanel.classList.add('show');
      }
      dayPanelClose.addEventListener('click', ()=> dayPanel.classList.remove('show'));

      function getManualValue(){
        if(!manualInput) return null;
        const raw = manualInput.value.trim();
        if(!raw){
          showErr('Type a number to save.');
          return null;
        }
        const value = Number(raw);
        if(!Number.isFinite(value)){
          showErr('Please enter a valid number.');
          return null;
        }
        return value;
      }

      async function insertManualValue(value){
        clearErr();
        if(!supa) return showErr('Please connect first.');
        setSync('Saving‚Ä¶', true);

        const prevDisplay = valEl.textContent;
        valEl.textContent = String(value);

        try{
          const cfgNow = getCfg();
          const ins = await supa.from(cfgNow.table)
            .insert({ [cfgNow.col]: value })
            .select(`id, ${cfgNow.col}, ${cfgNow.tcol}`)
            .single();

          if(ins.error) throw ins.error;

          lastUpdateEl.textContent = ins.data?.[cfgNow.tcol]
            ? new Date(ins.data[cfgNow.tcol]).toLocaleString(undefined,{ timeZone: TZ })
            : new Date().toLocaleString(undefined,{ timeZone: TZ });

          if(manualInput) manualInput.value = '';

          await refreshValue();
          await buildStrip();
          await buildAndRender();

          setSync('Synced', true);
          toast('Number saved');

        }catch(e){
          valEl.textContent = prevDisplay;
          setSync('Retry', false);
          showErr(e.message || 'Save failed');
          toast('Save failed ‚Äî please try again');
        }
      }

      async function deleteLatestToday(){
        clearErr();
        if(!supa) return showErr('Please connect first.');
        setSync('Deleting‚Ä¶', false);

        try{
          const cfgNow = getCfg();
          const { startISO, endISO } = istRangeForDay(new Date());
          const { data, error } = await supa
            .from(cfgNow.table)
            .select(`id, ${cfgNow.col}, ${cfgNow.tcol}`)
            .gte(cfgNow.tcol, startISO).lt(cfgNow.tcol, endISO)
            .order('id',{ascending:false})
            .limit(1);
          if(error) throw error;

          const latest = data?.[0];
          if(!latest){
            setSync('Synced', true);
            return toast('No entries from today to delete.');
          }

          const del = await supa.from(cfgNow.table).delete().eq('id', latest.id);
          if(del.error) throw del.error;

          await refreshValue();
          await buildStrip();
          await buildAndRender();

          setSync('Synced', true);
          toast('Deleted today\'s latest entry');

        }catch(e){
          setSync('Retry', false);
          showErr(e.message || 'Delete failed');
          toast('Delete failed ‚Äî please try again');
        }
      }

      manualSaveBtn?.addEventListener('click', ()=>{
        clearErr();
        const value = getManualValue();
        if(value !== null) insertManualValue(value);
      });
      manualInput?.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter'){
          e.preventDefault();
          clearErr();
          const value = getManualValue();
          if(value !== null) insertManualValue(value);
        }
      });
      deleteTodayBtn?.addEventListener('click', ()=>{
        if(confirm('Delete today\'s most recent entry?')){
          deleteLatestToday();
        }
      });

      // Filters (Overall only in FS)
      function activateFilter(mode, fromFullscreen=false){
        if(mode==='overall' && !fromFullscreen){ return; } // block in main
        currentMode = mode;
        filters.forEach(b=>b.classList.toggle('active', b.dataset.range===mode));
        fsFilters.forEach(b=>b.classList.toggle('active', b.dataset.rangeFs===mode));
        buildAndRender();
      }
      filters.forEach(b=>b.addEventListener('click', ()=> activateFilter(b.dataset.range, false)));
      fsFilters.forEach(b=>b.addEventListener('click', ()=> activateFilter(b.dataset.rangeFs, true)));

      // Fullscreen overlay
      function renderFull(){
        const ctx = document.getElementById('fsChart').getContext('2d');
        const grad = (c) => {
          const { chart } = c;
          const { top, bottom } = chart.chartArea || { top:0, bottom:0 };
          const g = chart.ctx.createLinearGradient(0, bottom, 0, top);
          g.addColorStop(0, 'rgba(110,100,232,0.10)');
          g.addColorStop(1, 'rgba(142,134,255,0.35)');
          return g;
        };
        const options = {
          responsive:true, maintainAspectRatio:false,
          animation:{ duration:400, easing:'easeOutCubic' },
          interaction:{ mode:'nearest', intersect:false },
          scales:{
            x:{
              grid:{display:false},
              ticks:{
                color:'rgba(234,243,239,.85)',
                font:{size:12,weight:600},
                callback: (_,i)=> (currentMode==='year' || currentMode==='overall') ? '' : (currentLabels[i] ?? '')
              }
            },
            y:{ beginAtZero:true, ticks:{ color:'rgba(234,243,239,.65)', precision:0 }, grid:{ color:'rgba(255,255,255,.06)', drawBorder:false } }
          },
          plugins:{ legend:{display:false}, tooltip:{ backgroundColor:'rgba(20,28,32,.92)', borderColor:'rgba(255,255,255,.08)', borderWidth:1, titleColor:'#EAF3EF', bodyColor:'#EAF3EF' } },
        };
        if(fsChart){
          fsChart.data.labels = currentLabels;
          fsChart.data.datasets[0].data = currentData;
          fsChart.update();
        }else{
          fsChart = new Chart(ctx, {
            type:'line',
            data:{ labels: currentLabels, datasets:[{
              label:'Count',
              data: currentData,
              tension:.35,
              fill:true,
              borderWidth:2,
              borderColor:'#8E86FF',
              backgroundColor: grad,
              pointRadius:4,
              pointHoverRadius:6,
              pointBackgroundColor:'#8E86FF',
              pointBorderWidth:0
            }]},
            options,
            plugins:[SegmentGuides]
          });
        }
      }
      btnFull.addEventListener('click', ()=>{
        fsOverlay.classList.remove('hidden');
        renderFull();
      });
      btnExit.addEventListener('click', ()=>{
        fsOverlay.classList.add('hidden');
        if(fsChart){ fsChart.destroy(); fsChart = null; }
      });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && !fsOverlay.classList.contains('hidden')) btnExit.click(); });

      // Kick off
      connect();
      restoreQuotes();
    })();

    /* ====================== SETTINGS QUOTES WIRING ====================== */
    (function QuotesUI(){
      document.getElementById('quote-next').addEventListener('click', nextQuote);
      document.getElementById('quote-shuffle').addEventListener('click', ()=>{
        localStorage.removeItem('nb:quotes');
        localStorage.removeItem('nb:quoteIdx');
        // rebuild via restoreQuotes in MainView init path (already called)
        const ev = new Event('click'); document.getElementById('quote-next').dispatchEvent(ev);
      });
      document.getElementById('quote-copy').addEventListener('click', async ()=>{
        try{
          const t = document.getElementById('quote-text').textContent || '';
          await navigator.clipboard.writeText(t);
          const toastMsg = document.getElementById('toast-msg'); toastMsg.textContent = 'Copied!';
          const toastEl = document.getElementById('toast'); toastEl.classList.remove('hide'); toastEl.style.opacity=1;
          setTimeout(()=>{ toastEl.classList.add('hide'); toastEl.style.opacity=0; }, 1000);
        }catch{}
      });
    })();

    /* ====================== CONNECTION VIEW ====================== */
    (function ConnectionView(){
      const byId = (id)=>document.getElementById(id);
      const fields = ["sb-url","sb-key","col-name","tb-name","tcol-name"];
      let supabaseClient = null;
      let currentRow = null;

      window.addEventListener("DOMContentLoaded", ()=>{
        fields.forEach(f=>{
          const v = localStorage.getItem("sb-num:"+f);
          if(v) byId(f).value = v;
        });
      });
      fields.forEach(f=>byId(f)?.addEventListener("input",()=>localStorage.setItem("sb-num:"+f,byId(f).value)));

      function safeEl(id){ return byId(id) || { addEventListener:()=>{}, classList:{toggle:()=>{},add:()=>{},remove:()=>{}}, value:"", textContent:"" }; }

      safeEl("toggle-key").addEventListener("click",()=>{
        const i=byId("sb-key"); if(!i) return;
        i.type=i.type==="password"?"text":"password";
        safeEl("toggle-key").textContent=i.type==="password"?"show":"hide";
      });

      safeEl("connect").addEventListener("click",connectAndLoad);
      safeEl("refresh").addEventListener("click",loadValue);
      safeEl("reset").addEventListener("click",()=>insertExact(0,true));
      safeEl("delete-all").addEventListener("click",deleteAllRows);
      document.querySelectorAll(".add-btn").forEach(b=>b.addEventListener("click",()=>increment(Number(b.dataset.add))));

      function setBusy(f){ safeEl("busy").classList.toggle("hidden",!f); }
      function clearErr(){ safeEl("err").classList.add("hidden"); safeEl("err").textContent=""; }
      function showErr(m){ safeEl("err").textContent="‚ùå "+m; safeEl("err").classList.remove("hidden"); setBusy(false); }

      async function connectAndLoad(){
        clearErr(); setBusy(true); safeEl("status").textContent="";
        const url=byId("sb-url")?.value?.trim(), key=byId("sb-key")?.value?.trim();
        if(!url||!key){ showErr("Please fill URL and Key."); return; }
        supabaseClient = window.supabase.createClient(url,key);
        try{
          await ensureRowExistsAndPickLatest(); await loadValue();
          safeEl("status").textContent="Connected ‚úî";
        }catch(e){ showErr(e.message||String(e)); }
        finally{ setBusy(false); }
      }

      async function ensureRowExistsAndPickLatest(){
        const table=byId("tb-name").value.trim();
        let {data,error}=await supabaseClient.from(table).select("*").order("id",{ascending:false}).limit(1);
        if(error) throw error;
        if(!data||data.length===0){
          const col=byId("col-name").value.trim();
          ({data,error}=await supabaseClient.from(table).insert({[col]:0}).select("*").single());
          if(error) throw error;
        }else data=data[0];
        currentRow=data;
      }

      async function loadValue(){
        if(!supabaseClient) return showErr("Connect first.");
        clearErr(); setBusy(true);
        try{
          const table=byId("tb-name").value.trim();
          let {data,error}=await supabaseClient.from(table).select("*").order("id",{ascending:false}).limit(1);
          if(error) throw error;
          currentRow=data?.[0]||{};
          const col=byId("col-name").value.trim();
          byId("value").textContent=Number(currentRow?.[col]??0)||"‚Äî";
        }catch(e){ showErr(e.message); }
        finally{ setBusy(false); }
      }

      async function increment(d){
        const col=byId("col-name").value.trim();
        const base=Number(currentRow?.[col]??0);
        await insertExact(base+d,false);
      }

      async function insertExact(nextVal,isReset=false){
        if(!supabaseClient) return showErr("Connect first.");
        clearErr(); setBusy(true);
        try{
          const table=byId("tb-name").value.trim();
          const {data,error}=await supabaseClient.from(table).insert({[ byId("col-name").value.trim() ]:nextVal}).select("*").single();
          if(error) throw error;
          currentRow=data;
          byId("value").textContent=nextVal;
          publishRunCode(isReset?"insert reset row":"insert new row", {data,error});
        }catch(e){ showErr(e.message); }
        finally{ setBusy(false); }
      }

      async function deleteAllRows(){
        if(!supabaseClient) return showErr("Connect first.");
        if(!confirm("Are you sure you want to delete ALL rows in this table?")) return;
        clearErr(); setBusy(true);
        try{
          const table=byId("tb-name").value.trim();
          const {error}=await supabaseClient.from(table).delete().neq("id",0);
          if(error) throw error;
          byId("value").textContent="‚Äî";
          publishRunCode("delete all rows",{data:"All rows deleted"});
          // notify Main view to reset its UI immediately
          window.dispatchEvent(new CustomEvent('sb:rows-cleared', { detail:{ table } }));
        }catch(e){ showErr(e.message); }
        finally{ setBusy(false); }
      }

      function publishRunCode(title,resp){
        const url=byId("sb-url").value.trim(), key=byId("sb-key").value.trim(), table=byId("tb-name").value.trim(), col=byId("col-name").value.trim();
        byId("code").textContent=
`import { createClient } from '@supabase/supabase-js'
const supabase=createClient('${escapeJs(url)}','${escapeJs(key)}')

// Insert or delete example
await supabase
  .from('${escapeJs(table)}')
  .insert({ '${escapeJs(col)}': NEXT_VALUE })
  .select('*')

// or delete all rows
await supabase
  .from('${escapeJs(table)}')
  .delete()
  .neq('id',0)`;
        byId("debug").textContent=JSON.stringify({title,...resp},null,2);
      }
      function escapeJs(s){return String(s).replaceAll("\\\\","\\\\\\\\").replaceAll("`","\\`").replaceAll("'","\\'");}
    })();
  </script>
</body>
</html>
