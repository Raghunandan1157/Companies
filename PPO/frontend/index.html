<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Image Analyzer + Q&A</title>
    <meta name="description" content="Upload report images and ask questions about their content using OCR">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --bg-card: #16213e;
            --text-primary: #e8e8e8;
            --text-secondary: #a0a0a0;
            --accent: #6c63ff;
            --accent-hover: #5a52d5;
            --success: #4ade80;
            --error: #ef4444;
            --warning: #fbbf24;
            --border: #2d2d44;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent), #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 25px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title .icon {
            font-size: 1.4rem;
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg-secondary);
        }

        .upload-area:hover,
        .upload-area.dragover {
            border-color: var(--accent);
            background: rgba(108, 99, 255, 0.1);
        }

        .upload-area input[type="file"] {
            display: none;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .upload-text {
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .upload-text strong {
            color: var(--accent);
        }

        .file-info {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Image Preview */
        .preview-container {
            display: none;
            margin-top: 20px;
        }

        .preview-container.show {
            display: block;
        }

        .preview-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .preview-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--accent-hover);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--border);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Question Input */
        .question-section {
            display: none;
        }

        .question-section.show {
            display: block;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        .input-group input {
            flex: 1;
            padding: 14px 18px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1rem;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .input-group input::placeholder {
            color: var(--text-secondary);
        }

        /* Results */
        .results-section {
            display: none;
        }

        .results-section.show {
            display: block;
        }

        .extracted-text {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            border: 1px solid var(--border);
            margin-bottom: 15px;
        }

        .toggle-btn {
            font-size: 0.9rem;
            padding: 8px 16px;
            margin-bottom: 15px;
        }

        .answer-box {
            background: linear-gradient(135deg, rgba(108, 99, 255, 0.2), rgba(168, 85, 247, 0.2));
            border-radius: 12px;
            padding: 25px;
            border: 1px solid var(--accent);
        }

        .answer-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .answer-text {
            font-size: 1.3rem;
            font-weight: 500;
        }

        .answer-text.not-found {
            color: var(--warning);
        }

        /* Status Messages */
        .status {
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }

        .status.show {
            display: block;
        }

        .status.loading {
            background: rgba(108, 99, 255, 0.2);
            color: var(--accent);
            border: 1px solid var(--accent);
        }

        .status.error {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
            border: 1px solid var(--error);
        }

        .status.success {
            background: rgba(74, 222, 128, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }

        /* Hints */
        .hints {
            margin-top: 15px;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .hints-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--accent);
        }

        .hint-item {
            display: flex;
            gap: 8px;
            margin-bottom: 5px;
        }

        .hint-label {
            color: var(--text-secondary);
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Responsive */
        @media (max-width: 600px) {
            h1 {
                font-size: 1.8rem;
            }

            .card {
                padding: 20px;
            }

            .input-group {
                flex-direction: column;
            }

            .input-group .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Report Image Analyzer</h1>
            <p class="subtitle">Upload a report image and ask questions about its content</p>
        </header>

        <!-- Upload Card -->
        <div class="card">
            <div class="card-title">
                <span class="icon">üì§</span>
                <span>Upload Report Image</span>
            </div>
            
            <div class="upload-area" id="uploadArea">
                <input type="file" id="fileInput" accept=".png,.jpg,.jpeg">
                <div class="upload-icon">üñºÔ∏è</div>
                <p class="upload-text">
                    <strong>Click to upload</strong> or drag and drop
                </p>
                <p class="file-info">PNG, JPG up to 10MB</p>
            </div>

            <div class="preview-container" id="previewContainer">
                <img id="previewImage" class="preview-image" alt="Uploaded image preview">
                <div class="preview-actions">
                    <button class="btn btn-primary" id="analyzeBtn">
                        üîç Analyze Image
                    </button>
                    <button class="btn btn-secondary" id="clearBtn">
                        ‚úñÔ∏è Clear
                    </button>
                </div>
            </div>

            <div class="status" id="analyzeStatus"></div>
        </div>

        <!-- Question Card -->
        <div class="card question-section" id="questionSection">
            <div class="card-title">
                <span class="icon">‚ùì</span>
                <span>Ask a Question</span>
            </div>
            
            <div class="input-group">
                <input 
                    type="text" 
                    id="questionInput" 
                    placeholder="e.g., What is the total sales amount?"
                >
                <button class="btn btn-primary" id="askBtn">
                    üöÄ Ask
                </button>
            </div>

            <div class="status" id="askStatus"></div>
        </div>

        <!-- Results Card -->
        <div class="card results-section" id="resultsSection">
            <div class="card-title">
                <span class="icon">üí°</span>
                <span>Results</span>
            </div>

            <button class="btn btn-secondary toggle-btn" id="toggleTextBtn">
                üìù Show Extracted Text
            </button>

            <div class="extracted-text" id="extractedText" style="display: none;"></div>

            <div class="hints" id="hintsContainer" style="display: none;">
                <div class="hints-title">üìã Detected Content</div>
                <div id="hintsContent"></div>
            </div>

            <div class="answer-box" id="answerBox" style="display: none;">
                <div class="answer-label">Answer</div>
                <div class="answer-text" id="answerText"></div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'http://localhost:8000';

        // DOM Elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        const previewImage = document.getElementById('previewImage');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const clearBtn = document.getElementById('clearBtn');
        const analyzeStatus = document.getElementById('analyzeStatus');
        const questionSection = document.getElementById('questionSection');
        const questionInput = document.getElementById('questionInput');
        const askBtn = document.getElementById('askBtn');
        const askStatus = document.getElementById('askStatus');
        const resultsSection = document.getElementById('resultsSection');
        const toggleTextBtn = document.getElementById('toggleTextBtn');
        const extractedTextDiv = document.getElementById('extractedText');
        const hintsContainer = document.getElementById('hintsContainer');
        const hintsContent = document.getElementById('hintsContent');
        const answerBox = document.getElementById('answerBox');
        const answerText = document.getElementById('answerText');

        // State
        let currentFile = null;
        let extractedText = '';

        // Utility Functions
        function showStatus(element, message, type) {
            element.textContent = message;
            element.className = `status show ${type}`;
        }

        function hideStatus(element) {
            element.className = 'status';
        }

        function showLoading(element, message) {
            element.innerHTML = `<span class="spinner"></span> ${message}`;
            element.className = 'status show loading';
        }

        // Upload Area Events
        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            // Validate file type
            const validTypes = ['image/png', 'image/jpeg', 'image/jpg'];
            if (!validTypes.includes(file.type)) {
                showStatus(analyzeStatus, '‚ùå Invalid file type. Please upload PNG or JPG.', 'error');
                return;
            }

            // Validate file size (10MB)
            if (file.size > 10 * 1024 * 1024) {
                showStatus(analyzeStatus, '‚ùå File too large. Maximum size is 10MB.', 'error');
                return;
            }

            currentFile = file;
            hideStatus(analyzeStatus);

            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImage.src = e.target.result;
                previewContainer.classList.add('show');
            };
            reader.readAsDataURL(file);

            // Reset results
            questionSection.classList.remove('show');
            resultsSection.classList.remove('show');
            extractedText = '';
        }

        // Clear Button
        clearBtn.addEventListener('click', () => {
            currentFile = null;
            fileInput.value = '';
            previewContainer.classList.remove('show');
            questionSection.classList.remove('show');
            resultsSection.classList.remove('show');
            hideStatus(analyzeStatus);
            hideStatus(askStatus);
            extractedText = '';
        });

        // Analyze Button
        analyzeBtn.addEventListener('click', async () => {
            if (!currentFile) {
                showStatus(analyzeStatus, '‚ùå Please select an image first.', 'error');
                return;
            }

            analyzeBtn.disabled = true;
            showLoading(analyzeStatus, 'Analyzing image...');

            try {
                const formData = new FormData();
                formData.append('file', currentFile);

                const response = await fetch(`${API_BASE}/analyze`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Analysis failed');
                }

                extractedText = data.extracted_text;
                
                // Show results section
                resultsSection.classList.add('show');
                extractedTextDiv.textContent = extractedText;
                
                // Show hints
                if (data.structured_hints) {
                    const hints = data.structured_hints;
                    let hintsHtml = '';
                    
                    if (hints.num_words) {
                        hintsHtml += `<div class="hint-item"><span class="hint-label">Words detected:</span> ${hints.num_words}</div>`;
                    }
                    if (hints.possible_tables) {
                        hintsHtml += `<div class="hint-item"><span class="hint-label">üìä Table structure detected</span></div>`;
                    }
                    if (hints.numbers_found && hints.numbers_found.length > 0) {
                        hintsHtml += `<div class="hint-item"><span class="hint-label">Numbers found:</span> ${hints.numbers_found.slice(0, 5).join(', ')}${hints.numbers_found.length > 5 ? '...' : ''}</div>`;
                    }
                    if (hints.labels_found && hints.labels_found.length > 0) {
                        hintsHtml += `<div class="hint-item"><span class="hint-label">Labels found:</span> ${hints.labels_found.slice(0, 5).join(', ')}${hints.labels_found.length > 5 ? '...' : ''}</div>`;
                    }
                    
                    if (hintsHtml) {
                        hintsContent.innerHTML = hintsHtml;
                        hintsContainer.style.display = 'block';
                    }
                }

                // Show question section
                questionSection.classList.add('show');
                questionInput.focus();

                showStatus(analyzeStatus, '‚úÖ Image analyzed successfully!', 'success');
                
                setTimeout(() => hideStatus(analyzeStatus), 3000);

            } catch (error) {
                console.error('Analysis error:', error);
                showStatus(analyzeStatus, `‚ùå ${error.message}`, 'error');
            } finally {
                analyzeBtn.disabled = false;
            }
        });

        // Toggle Extracted Text
        toggleTextBtn.addEventListener('click', () => {
            const isHidden = extractedTextDiv.style.display === 'none';
            extractedTextDiv.style.display = isHidden ? 'block' : 'none';
            toggleTextBtn.textContent = isHidden ? 'üìù Hide Extracted Text' : 'üìù Show Extracted Text';
        });

        // Ask Button
        askBtn.addEventListener('click', askQuestion);
        questionInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                askQuestion();
            }
        });

        async function askQuestion() {
            const question = questionInput.value.trim();
            
            if (!question) {
                showStatus(askStatus, '‚ùå Please enter a question.', 'error');
                return;
            }

            if (!extractedText) {
                showStatus(askStatus, '‚ùå Please analyze an image first.', 'error');
                return;
            }

            askBtn.disabled = true;
            showLoading(askStatus, 'Finding answer...');

            try {
                const response = await fetch(`${API_BASE}/ask/json`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        extracted_text: extractedText,
                        question: question
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to get answer');
                }

                // Show answer
                answerBox.style.display = 'block';
                answerText.textContent = data.answer;
                
                // Style differently if not found
                if (data.answer === "The image does not contain this information.") {
                    answerText.classList.add('not-found');
                } else {
                    answerText.classList.remove('not-found');
                }

                hideStatus(askStatus);

            } catch (error) {
                console.error('Ask error:', error);
                showStatus(askStatus, `‚ùå ${error.message}`, 'error');
            } finally {
                askBtn.disabled = false;
            }
        }

        // Health check on load
        async function checkHealth() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                if (data.status !== 'ok') {
                    console.warn('Backend health check failed');
                }
            } catch (error) {
                console.warn('Backend not available:', error.message);
                showStatus(analyzeStatus, '‚ö†Ô∏è Backend server not running. Start with: uvicorn server:app --reload', 'error');
            }
        }

        checkHealth();

        /*
         * Example Fetch Code:
         * 
         * // Analyze an image
         * const formData = new FormData();
         * formData.append('file', fileInput.files[0]);
         * 
         * const analyzeResponse = await fetch('http://localhost:8000/analyze', {
         *     method: 'POST',
         *     body: formData
         * });
         * const analyzeData = await analyzeResponse.json();
         * console.log('Extracted text:', analyzeData.extracted_text);
         * 
         * // Ask a question
         * const askResponse = await fetch('http://localhost:8000/ask/json', {
         *     method: 'POST',
         *     headers: { 'Content-Type': 'application/json' },
         *     body: JSON.stringify({
         *         extracted_text: analyzeData.extracted_text,
         *         question: 'What is the total?'
         *     })
         * });
         * const askData = await askResponse.json();
         * console.log('Answer:', askData.answer);
         */
    </script>
</body>
</html>
